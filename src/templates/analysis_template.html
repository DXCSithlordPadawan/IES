<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis - IES4 Military Database Analysis</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/fontawesome.min.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">
    <script src="/static/js/plotly.min.js"></script>
	<script src="/static/enhanced-database-manager.js"></script>
    <style>
        .analysis-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .filter-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .visualization-container {
            min-height: 600px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .stats-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }
        .filter-badge {
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            display: inline-block;
            font-size: 0.875rem;
        }
        .equipment-category-checkbox {
            margin-bottom: 8px;
        }
        .equipment-category-checkbox .form-check-label {
            font-size: 0.9rem;
            cursor: pointer;
        }
        .equipment-category-checkbox .form-check-label small {
            color: #6c757d;
            display: block;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                IES4 Military Analysis
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/analysis">Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/comparison">Comparison</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-search me-2"></i>
                    Interactive Analysis
                </h1>
            </div>
        </div>

        <div class="row">
            <!-- Controls Panel -->
            <div class="col-lg-3">
                <!-- Database Selection -->
                <div class="analysis-container">
                    <h5><i class="fas fa-database me-2"></i>Database Selection</h5>
                    <form id="analysisForm">
                        <div class="mb-3">
                            <label for="databaseSelect" class="form-label">Database</label>
                            <select class="form-select" id="databaseSelect" required>
                                <option value="">Select database...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="layoutSelect" class="form-label">Layout Algorithm</label>
                            <select class="form-select" id="layoutSelect">
                                <option value="spring">Spring Layout</option>
                                <option value="hierarchical">Hierarchical</option>
                                <option value="circular">Circular</option>
                                <option value="force">Force-Directed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showLabels" checked>
                                <label class="form-check-label" for="showLabels">
                                    Show Node Labels
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="runAnalysis()">
                            <i class="fas fa-play me-2"></i>Run Analysis
                        </button>
                    </form>
                </div>

                <!-- Filters Panel -->
                <div class="filter-panel">
                    <h5><i class="fas fa-filter me-2"></i>Filters</h5>
                    <div id="active-filters" class="mb-3">
                        <small class="text-muted">No active filters</small>
                    </div>
                    
                    <div class="accordion" id="filterAccordion">
                        <!-- Country Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#countryFilter">
                                    Country
                                </button>
                            </h2>
                            <div id="countryFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <select class="form-select form-select-sm" id="countryFilterSelect">
                                        <option value="">All Countries</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Type Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#typeFilter">
                                    Entity Type
                                </button>
                            </h2>
                            <div id="typeFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <select class="form-select form-select-sm" id="typeFilterSelect">
                                        <option value="">All Types</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Year Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#yearFilter">
                                    Year
                                </button>
                            </h2>
                            <div id="yearFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">From</label>
                                            <input type="number" class="form-control form-control-sm" id="yearFrom" placeholder="1900">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">To</label>
                                            <input type="number" class="form-control form-control-sm" id="yearTo" placeholder="2025">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Keyword Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#keywordFilter">
                                    Keyword Search
                                </button>
                            </h2>
                            <div id="keywordFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <input type="text" class="form-control form-control-sm" id="keywordInput" placeholder="Enter search terms...">
                                </div>
                            </div>
                        </div>

                        <!-- Equipment Category Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#equipmentCategoryFilter">
                                    Equipment Categories
                                </button>
                            </h2>
                            <div id="equipmentCategoryFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <small class="text-muted">Select multiple categories to filter by equipment type</small>
                                    </div>
                                    <div id="equipment-category-checkboxes">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-success btn-sm w-100" onclick="applyFilters()">
                            <i class="fas fa-check me-2"></i>Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear All
                        </button>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div class="analysis-container">
                    <h5><i class="fas fa-chart-pie me-2"></i>Quick Stats</h5>
                    <div id="quick-stats">
                        <div class="stats-card">
                            <div class="h4 mb-1" id="stat-nodes">-</div>
                            <small>Nodes</small>
                        </div>
                        <div class="stats-card">
                            <div class="h4 mb-1" id="stat-edges">-</div>
                            <small>Connections</small>
                        </div>
                        <div class="stats-card">
                            <div class="h4 mb-1" id="stat-density">-</div>
                            <small>Density</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="col-lg-9">
                <div class="analysis-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-project-diagram me-2"></i>Network Visualization</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportVisualization()">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="fullscreenView()">
                                <i class="fas fa-expand me-1"></i>Fullscreen
                            </button>
                        </div>
                    </div>
                    
                    <div id="visualization-area" class="visualization-container">
                        <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Select a database and click "Run Analysis" to begin</h5>
                        <p class="text-muted">Interactive network visualization will appear here</p>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div class="analysis-container" id="analysis-results" style="display: none;">
                    <h5><i class="fas fa-analytics me-2"></i>Analysis Results</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Top Connected Entities</h6>
                            <div id="top-entities" class="small">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Entity Type Distribution</h6>
                            <div id="entity-distribution" class="small">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFilters = {};
        let currentDatabase = null;
        let currentVisualization = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableDatabases();
            loadFilterSuggestions();
            loadEquipmentCategories();
        });

        function loadAvailableDatabases() {
            fetch('/api/databases')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('databaseSelect');
                    select.innerHTML = '<option value="">Select database...</option>';
                    
                    if (data.status === 'success') {
                        data.available.forEach(db => {
                            const option = document.createElement('option');
                            option.value = db;
                            option.textContent = db.replace(/_/g, ' ').toUpperCase();
                            if (data.loaded.includes(db)) {
                                option.textContent += ' (Loaded)';
                            }
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading databases:', error));
        }

        function loadFilterSuggestions() {
            fetch('/api/filter_suggestions')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const suggestions = data.suggestions;
                        
                        // Populate country filter
                        const countrySelect = document.getElementById('countryFilterSelect');
                        suggestions.countries.forEach(country => {
                            const option = document.createElement('option');
                            option.value = country;
                            option.textContent = country;
                            countrySelect.appendChild(option);
                        });

                        // Populate type filter
                        const typeSelect = document.getElementById('typeFilterSelect');
                        suggestions.types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            typeSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading filter suggestions:', error));
        }

        function loadEquipmentCategories() {
            fetch('/api/equipment_categories')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const container = document.getElementById('equipment-category-checkboxes');
                        container.innerHTML = '';
                        
                        Object.entries(data.categories).forEach(([key, category]) => {
                            const checkboxDiv = document.createElement('div');
                            checkboxDiv.className = 'form-check equipment-category-checkbox';
                            
                            checkboxDiv.innerHTML = `
                                <input class="form-check-input" type="checkbox" id="category_${key}" value="${key}">
                                <label class="form-check-label" for="category_${key}">
                                    ${category.label}
                                    <small>${category.description}</small>
                                </label>
                            `;
                            
                            container.appendChild(checkboxDiv);
                        });
                    }
                })
                .catch(error => console.error('Error loading equipment categories:', error));
        }

        function runAnalysis() {
            const database = document.getElementById('databaseSelect').value;
            const layout = document.getElementById('layoutSelect').value;
            const showLabels = document.getElementById('showLabels').checked;

            if (!database) {
                alert('Please select a database');
                return;
            }

            currentDatabase = database;
            window.currentDatabase = database; // Ensure window global is also set
            
            // Update data popup manager if available
            if (window.dataPopupManager) {
                window.dataPopupManager.setCurrentDatabase(database);
                console.log('✅ Updated popup manager to use database:', database);
            }

            // Show loading state
            const vizArea = document.getElementById('visualization-area');
            vizArea.innerHTML = `
                <div class="spinner-border text-primary" role="status"></div>
                <h5 class="text-muted mt-3">Analyzing ${database}...</h5>
                <p class="text-muted">This may take a few moments</p>
            `;

            // Prepare analysis request
            const analysisData = {
                database_name: database,
                layout: layout,
                show_labels: showLabels,
                filters: currentFilters
            };

            fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(analysisData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayVisualization(data);
                    updateStats(data);
                    showAnalysisResults(data.statistics);
                } else {
                    showError('Analysis failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error running analysis:', error);
                showError('Connection error during analysis');
            });
        }

        function displayVisualization(data) {
            const vizArea = document.getElementById('visualization-area');
            vizArea.innerHTML = '';
            vizArea.style.border = 'none';

            // Create the plot
            currentVisualization = data.visualization;
            Plotly.newPlot('visualization-area', data.visualization.data, data.visualization.layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            });
        }

        function updateStats(data) {
            document.getElementById('stat-nodes').textContent = data.node_count.toLocaleString();
            document.getElementById('stat-edges').textContent = data.edge_count.toLocaleString();
            
            const density = data.edge_count > 0 ? (data.edge_count / (data.node_count * (data.node_count - 1) / 2)).toFixed(3) : '0';
            document.getElementById('stat-density').textContent = density;
        }

        function showAnalysisResults(statistics) {
            const resultsDiv = document.getElementById('analysis-results');
            resultsDiv.style.display = 'block';

            // Top entities by centrality
            const topEntitiesDiv = document.getElementById('top-entities');
            if (statistics.centrality && statistics.centrality.top_degree_centrality) {
                let html = '<ul class="list-unstyled">';
                statistics.centrality.top_degree_centrality.slice(0, 5).forEach(([entity, score]) => {
                    html += `<li><strong>${entity}</strong> (${score.toFixed(3)})</li>`;
                });
                html += '</ul>';
                topEntitiesDiv.innerHTML = html;
            }

            // Entity distribution
            const distributionDiv = document.getElementById('entity-distribution');
            if (statistics.node_statistics && statistics.node_statistics.node_types) {
                let html = '<ul class="list-unstyled">';
                Object.entries(statistics.node_statistics.node_types).forEach(([type, count]) => {
                    html += `<li><strong>${type.replace(/_/g, ' ')}</strong>: ${count}</li>`;
                });
                html += '</ul>';
                distributionDiv.innerHTML = html;
            }
        }

        function applyFilters() {
            currentFilters = {};

            // Collect filter values
            const country = document.getElementById('countryFilterSelect').value;
            const type = document.getElementById('typeFilterSelect').value;
            const yearFrom = document.getElementById('yearFrom').value;
            const yearTo = document.getElementById('yearTo').value;
            const keyword = document.getElementById('keywordInput').value.trim();

            // Collect selected equipment categories
            const selectedCategories = [];
            document.querySelectorAll('input[id^="category_"]:checked').forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });

            if (country) currentFilters.country = country;
            if (type) currentFilters.type = type;
            if (yearFrom && yearTo) currentFilters.year_range = `${yearFrom}-${yearTo}`;
            else if (yearFrom) currentFilters.year = parseInt(yearFrom);
            if (keyword) currentFilters.keyword = keyword;
            if (selectedCategories.length > 0) currentFilters.equipment_category = selectedCategories;

            updateActiveFilters();

            // Re-run analysis if database is selected
            if (currentDatabase) {
                runAnalysis();
            }
        }

        function clearFilters() {
            currentFilters = {};
            
            // Clear form fields
            document.getElementById('countryFilterSelect').value = '';
            document.getElementById('typeFilterSelect').value = '';
            document.getElementById('yearFrom').value = '';
            document.getElementById('yearTo').value = '';
            document.getElementById('keywordInput').value = '';

            // Clear equipment category checkboxes
            document.querySelectorAll('input[id^="category_"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            updateActiveFilters();

            // Re-run analysis if database is selected
            if (currentDatabase) {
                runAnalysis();
            }
        }

        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('active-filters');
            
            if (Object.keys(currentFilters).length === 0) {
                activeFiltersDiv.innerHTML = '<small class="text-muted">No active filters</small>';
            } else {
                let html = '';
                Object.entries(currentFilters).forEach(([key, value]) => {
                    if (key === 'equipment_category' && Array.isArray(value)) {
                        // Special handling for equipment categories
                        html += `<span class="filter-badge">${key}: ${value.length} selected</span>`;
                    } else {
                        html += `<span class="filter-badge">${key}: ${value}</span>`;
                    }
                });
                activeFiltersDiv.innerHTML = html;
            }
        }

        function exportVisualization() {
            if (currentVisualization) {
                Plotly.downloadImage('visualization-area', {
                    format: 'png',
                    filename: `military_analysis_${currentDatabase}_${Date.now()}`,
                    height: 800,
                    width: 1200
                });
            } else {
                alert('No visualization to export. Please run an analysis first.');
            }
        }

        function fullscreenView() {
            if (currentVisualization) {
                const elem = document.getElementById('visualization-area');
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }
        }

        function showError(message) {
            const vizArea = document.getElementById('visualization-area');
            vizArea.innerHTML = `
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5 class="text-danger">Error</h5>
                <p class="text-muted">${message}</p>
            `;
            vizArea.style.border = '2px dashed #ddd';
        }
    </script>
    
    <!-- Local JavaScript Assets -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/filtering.js"></script>
</body>
</html>