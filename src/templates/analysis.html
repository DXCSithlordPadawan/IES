<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis - IES4 Military Database Analysis</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/fontawesome.min.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">
    <link href="/static/css/data-popup.css" rel="stylesheet">
    <script src="/static/js/plotly-3.1.0.min.js"></script>
	<script src="/static/js/enhanced-database-manager.js"></script>
    <script src="/static/js/filtering.js"></script>
    <style>
        .analysis-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .filter-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .visualization-container {
            min-height: 600px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .stats-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }
        .filter-badge {
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            display: inline-block;
            font-size: 0.875rem;
        }
        .auto-refresh-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.875rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .auto-refresh-indicator.paused {
            background: rgba(220, 53, 69, 0.9);
        }
        .auto-refresh-indicator .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .auto-refresh-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .refresh-status {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .changes-indicator {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .last-update-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 5px;
        }
        .comparison-highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
        }
        .equipment-category-checkbox {
            margin-bottom: 8px;
        }
        .equipment-category-checkbox .form-check-label {
            font-size: 0.9rem;
            cursor: pointer;
        }
        .equipment-category-checkbox .form-check-label small {
            color: #6c757d;
            display: block;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Auto-refresh indicator -->
    <div id="auto-refresh-indicator" class="auto-refresh-indicator" style="display: none;">
        <div class="spinner"></div>
        <span id="refresh-status-text">Auto-refresh active</span>
        <span id="refresh-countdown">(5s)</span>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                IES4 Military Analysis
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/analysis">Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/comparison">Comparison</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-search me-2"></i>
                    Interactive Analysis
                    <small class="text-muted fs-6">Real-time Updates</small>
                </h1>
            </div>
        </div>

        <div class="row">
            <!-- Controls Panel -->
            <div class="col-lg-3">
                <!-- Database Selection -->
                <div class="analysis-container">
                    <h5><i class="fas fa-database me-2"></i>Database Selection</h5>
                    <form id="analysisForm">
                        <div class="mb-3">
                            <label for="databaseSelect" class="form-label">Database</label>
                            <select class="form-select" id="databaseSelect" required>
                                <option value="">Select database...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="layoutSelect" class="form-label">Layout Algorithm</label>
                            <select class="form-select" id="layoutSelect">
                                <option value="spring">Spring Layout</option>
                                <option value="hierarchical">Hierarchical</option>
                                <option value="circular">Circular</option>
                                <option value="force">Force-Directed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showLabels" checked>
                                <label class="form-check-label" for="showLabels">
                                    Show Node Labels
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary w-100" onclick="runAnalysis()">
                            <i class="fas fa-play me-2"></i>Run Analysis
                        </button>
                        <button type="button" class="btn btn-secondary w-100 mt-2" onclick="pauseAutoRefresh()">
                            <i class="fas fa-pause me-2"></i><span id="pause-btn-text">Pause Auto-Refresh</span>
                        </button>
                    </form>
                </div>

                <!-- Filters Panel -->
                <div class="filter-panel">
                    <h5><i class="fas fa-filter me-2"></i>Filters</h5>
                    <div id="active-filters" class="mb-3">
                        <small class="text-muted">No active filters</small>
                    </div>
                    
                    <div class="accordion" id="filterAccordion">
                        <!-- Country Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#countryFilter">
                                    Country
                                </button>
                            </h2>
                            <div id="countryFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <select class="form-select form-select-sm" id="countryFilterSelect">
                                        <option value="">All Countries</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Type Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#typeFilter">
                                    Entity Type
                                </button>
                            </h2>
                            <div id="typeFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <select class="form-select form-select-sm" id="typeFilterSelect">
                                        <option value="">All Types</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Year Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#yearFilter">
                                    Year
                                </button>
                            </h2>
                            <div id="yearFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">From</label>
                                            <input type="number" class="form-control form-control-sm" id="yearFrom" placeholder="1900">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">To</label>
                                            <input type="number" class="form-control form-control-sm" id="yearTo" placeholder="2025">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Keyword Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#keywordFilter">
                                    Keyword Search
                                </button>
                            </h2>
                            <div id="keywordFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <input type="text" class="form-control form-control-sm" id="keywordInput" placeholder="Enter search terms...">
                                </div>
                            </div>
                        </div>

                        <!-- Equipment Category Filter -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#equipmentCategoryFilter">
                                    Equipment Categories
                                </button>
                            </h2>
                            <div id="equipmentCategoryFilter" class="accordion-collapse collapse" data-bs-parent="#filterAccordion">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <small class="text-muted">Select multiple categories to filter by equipment type</small>
                                    </div>
                                    <div id="equipment-category-checkboxes">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-success btn-sm w-100" onclick="applyFilters()">
                            <i class="fas fa-check me-2"></i>Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear All
                        </button>
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div class="analysis-container">
                    <h5><i class="fas fa-chart-pie me-2"></i>Quick Stats</h5>
                    <div id="quick-stats">
                        <div class="stats-card">
                            <div class="h4 mb-1" id="stat-nodes">-</div>
                            <small>Nodes</small>
                        </div>
                        <div class="stats-card">
                            <div class="h4 mb-1" id="stat-edges">-</div>
                            <small>Connections</small>
                        </div>
                        <div class="stats-card">
                            <div class="h4 mb-1" id="stat-density">-</div>
                            <small>Density</small>
                        </div>
                    </div>
                </div>

                <!-- Auto-Refresh Controls -->
                <div class="auto-refresh-controls">
                    <h6><i class="fas fa-sync-alt me-2"></i>Auto-Refresh</h6>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                        <label class="form-check-label" for="autoRefreshToggle">
                            Enable Auto-Refresh
                        </label>
                    </div>
                    <div class="mb-2">
                        <label for="refreshInterval" class="form-label">Interval (seconds)</label>
                        <select class="form-select form-select-sm" id="refreshInterval">
                            <option value="3">3 seconds</option>
                            <option value="5" selected>5 seconds</option>
                            <option value="10">10 seconds</option>
                            <option value="15">15 seconds</option>
                            <option value="30">30 seconds</option>
                        </select>
                    </div>
                    <div class="refresh-status">
                        <div id="refresh-status">
                            <i class="fas fa-circle text-success"></i>
                            Auto-refresh enabled
                        </div>
                        <div class="last-update-time" id="last-update-time">
                            Never updated
                        </div>
                    </div>
                </div>

                <!-- Changes Detection Panel -->
                <div class="analysis-container">
                    <h5><i class="fas fa-history me-2"></i>Changes Detected</h5>
                    <div id="changes-log" class="small">
                        <div class="text-muted">No changes detected yet</div>
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="col-lg-9">
                <div class="analysis-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5><i class="fas fa-project-diagram me-2"></i>Network Visualization</h5>
                            <div id="changes-indicator" class="changes-indicator" style="display: none;">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                Changes detected - refreshing...
                            </div>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportVisualization()">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="fullscreenView()">
                                <i class="fas fa-expand me-1"></i>Fullscreen
                            </button>
                        </div>
                    </div>
                    
                    <div id="visualization-area" class="visualization-container">
                        <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Select a database and click "Run Analysis" to begin</h5>
                        <p class="text-muted">Interactive network visualization will appear here</p>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div class="analysis-container" id="analysis-results" style="display: none;">
                    <h5><i class="fas fa-analytics me-2"></i>Analysis Results</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Top Connected Entities</h6>
                            <div id="top-entities" class="small">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Entity Type Distribution</h6>
                            <div id="entity-distribution" class="small">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison with previous results -->
                    <div id="comparison-results" class="mt-3" style="display: none;">
                        <h6>Changes Since Last Update</h6>
                        <div id="comparison-details" class="small">
                            <!-- Will be populated with change details -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh functionality
        let autoRefreshEnabled = true;
        let refreshInterval = 5; // seconds
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownValue = 0;

        // Analysis state - use existing currentFilters if available
        if (typeof currentFilters === 'undefined') {
            var currentFilters = {};
        }
        let currentDatabase = null;
        let currentVisualization = null;
        let previousResults = null;
        let lastRefreshTime = null;

        // Changes tracking
        let changesLog = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableDatabases();
            loadFilterSuggestions();
            loadEquipmentCategories();
            
            // Set up auto-refresh controls
            setupAutoRefreshControls();
            
            // Start auto-refresh if enabled
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        });

        function setupAutoRefreshControls() {
            // Auto-refresh toggle
            document.getElementById('autoRefreshToggle').addEventListener('change', function() {
                autoRefreshEnabled = this.checked;
                if (autoRefreshEnabled && currentDatabase) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
                updateRefreshStatus();
            });

            // Refresh interval change
            document.getElementById('refreshInterval').addEventListener('change', function() {
                refreshInterval = parseInt(this.value);
                if (autoRefreshEnabled && currentDatabase) {
                    stopAutoRefresh();
                    startAutoRefresh();
                }
            });
        }

        function startAutoRefresh() {
            if (!currentDatabase || !autoRefreshEnabled) return;
            
            console.log(`🔄 Starting auto-refresh every ${refreshInterval} seconds`);
            
            // Show indicator
            const indicator = document.getElementById('auto-refresh-indicator');
            indicator.style.display = 'flex';
            indicator.classList.remove('paused');
            
            // Start countdown
            startCountdown();
            
            // Set up refresh timer
            refreshTimer = setInterval(() => {
                if (autoRefreshEnabled && currentDatabase) {
                    refreshAnalysis();
                    startCountdown(); // Restart countdown
                }
            }, refreshInterval * 1000);
            
            updateRefreshStatus();
        }

        function stopAutoRefresh() {
            console.log('⏸️ Stopping auto-refresh');
            
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // Hide or update indicator
            const indicator = document.getElementById('auto-refresh-indicator');
            if (!autoRefreshEnabled) {
                indicator.style.display = 'none';
            } else {
                indicator.classList.add('paused');
                document.getElementById('refresh-status-text').textContent = 'Auto-refresh paused';
            }
            
            updateRefreshStatus();
        }

        function startCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            countdownValue = refreshInterval;
            updateCountdownDisplay();
            
            countdownTimer = setInterval(() => {
                countdownValue--;
                updateCountdownDisplay();
                
                if (countdownValue <= 0) {
                    clearInterval(countdownTimer);
                }
            }, 1000);
        }

        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('refresh-countdown');
            if (countdownEl) {
                countdownEl.textContent = `(${countdownValue}s)`;
            }
        }

        function updateRefreshStatus() {
            const statusEl = document.getElementById('refresh-status');
            const timeEl = document.getElementById('last-update-time');
            
            if (autoRefreshEnabled && currentDatabase) {
                statusEl.innerHTML = '<i class="fas fa-circle text-success"></i> Auto-refresh active';
                document.getElementById('refresh-status-text').textContent = 'Auto-refresh active';
            } else if (currentDatabase) {
                statusEl.innerHTML = '<i class="fas fa-circle text-warning"></i> Auto-refresh paused';
                document.getElementById('refresh-status-text').textContent = 'Auto-refresh paused';
            } else {
                statusEl.innerHTML = '<i class="fas fa-circle text-secondary"></i> Select database to start';
                document.getElementById('refresh-status-text').textContent = 'Select database';
            }
            
            if (lastRefreshTime) {
                timeEl.textContent = `Last updated: ${lastRefreshTime.toLocaleTimeString()}`;
            }
        }

        async function refreshAnalysis() {
            if (!currentDatabase) return;
            
            try {
                console.log(`🔄 Auto-refreshing analysis for ${currentDatabase}`);
                
                // Show changes indicator
                const indicator = document.getElementById('changes-indicator');
                indicator.style.display = 'inline-block';
                
                // Run analysis with force reload
                const result = await runAnalysisInternal(true, false); // force reload, don't show loading
                
                if (result) {
                    // Check for changes
                    const hasChanges = detectChanges(result);
                    
                    if (hasChanges) {
                        logChange('Data refreshed - changes detected');
                        
                        // Update visualization
                        displayVisualization(result);
                        updateStats(result);
                        showAnalysisResults(result.statistics);
                    } else {
                        logChange('Data refreshed - no changes detected');
                    }
                    
                    lastRefreshTime = new Date();
                    updateRefreshStatus();
                }
                
                // Hide changes indicator after a delay
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Auto-refresh failed:', error);
                logChange(`Auto-refresh failed: ${error.message}`, 'error');
            }
        }

        function detectChanges(newResults) {
            if (!previousResults) {
                previousResults = newResults;
                return true; // First run counts as change
            }
            
            // Compare key metrics
            const nodeCountChanged = newResults.node_count !== previousResults.node_count;
            const edgeCountChanged = newResults.edge_count !== previousResults.edge_count;
            const vehicleCountChanged = newResults.vehicle_count !== previousResults.vehicle_count;
            const areaCountChanged = newResults.area_count !== previousResults.area_count;
            
            const hasChanges = nodeCountChanged || edgeCountChanged || vehicleCountChanged || areaCountChanged;
            
            if (hasChanges) {
                // Log specific changes
                const changes = [];
                if (nodeCountChanged) changes.push(`Nodes: ${previousResults.node_count} → ${newResults.node_count}`);
                if (edgeCountChanged) changes.push(`Edges: ${previousResults.edge_count} → ${newResults.edge_count}`);
                if (vehicleCountChanged) changes.push(`Vehicles: ${previousResults.vehicle_count} → ${newResults.vehicle_count}`);
                if (areaCountChanged) changes.push(`Areas: ${previousResults.area_count} → ${newResults.area_count}`);
                
                // Show comparison
                showComparison(changes);
                
                previousResults = newResults;
            }
            
            return hasChanges;
        }

        function showComparison(changes) {
            const comparisonDiv = document.getElementById('comparison-results');
            const detailsDiv = document.getElementById('comparison-details');
            
            let html = '';
            changes.forEach(change => {
                html += `<div class="comparison-highlight">${change}</div>`;
            });
            
            detailsDiv.innerHTML = html;
            comparisonDiv.style.display = 'block';
        }

        function logChange(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const change = {
                time: timestamp,
                message: message,
                type: type
            };
            
            changesLog.unshift(change); // Add to beginning
            
            // Keep only last 10 changes
            if (changesLog.length > 10) {
                changesLog = changesLog.slice(0, 10);
            }
            
            updateChangesLog();
        }

        function updateChangesLog() {
            const logDiv = document.getElementById('changes-log');
            
            if (changesLog.length === 0) {
                logDiv.innerHTML = '<div class="text-muted">No changes detected yet</div>';
                return;
            }
            
            let html = '';
            changesLog.forEach(change => {
                const iconClass = change.type === 'error' ? 'text-danger fas fa-exclamation-triangle' : 'text-success fas fa-check-circle';
                html += `
                    <div class="mb-1">
                        <small class="text-muted">${change.time}</small>
                        <br>
                        <i class="${iconClass}"></i>
                        <small>${change.message}</small>
                    </div>
                `;
            });
            
            logDiv.innerHTML = html;
        }

        function pauseAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            document.getElementById('autoRefreshToggle').checked = autoRefreshEnabled;
            
            const btn = document.querySelector('#pause-btn-text');
            
            if (autoRefreshEnabled) {
                btn.textContent = 'Pause Auto-Refresh';
                if (currentDatabase) {
                    startAutoRefresh();
                }
            } else {
                btn.textContent = 'Resume Auto-Refresh';
                stopAutoRefresh();
            }
            
            updateRefreshStatus();
        }

        // Enhanced runAnalysis function with auto-refresh support
        async function runAnalysis() {
            const database = document.getElementById('databaseSelect').value;
            
            if (!database) {
                alert('Please select a database');
                return;
            }
            
            currentDatabase = database;
            
            // Stop auto-refresh temporarily
            const wasAutoRefreshEnabled = autoRefreshEnabled;
            if (autoRefreshEnabled) {
                stopAutoRefresh();
            }
            
            try {
                const result = await runAnalysisInternal(true, true); // force reload, show loading
                
                if (result) {
                    previousResults = result;
                    lastRefreshTime = new Date();
                    
                    // Restart auto-refresh if it was enabled
                    if (wasAutoRefreshEnabled) {
                        autoRefreshEnabled = true;
                        document.getElementById('autoRefreshToggle').checked = true;
                        startAutoRefresh();
                    }
                    
                    updateRefreshStatus();
                    logChange('Manual analysis completed');
                }
                
            } catch (error) {
                console.error('Analysis failed:', error);
                logChange(`Manual analysis failed: ${error.message}`, 'error');
                
                // Restart auto-refresh even on error if it was enabled
                if (wasAutoRefreshEnabled) {
                    autoRefreshEnabled = true;
                    document.getElementById('autoRefreshToggle').checked = true;
                    startAutoRefresh();
                }
            }
        }

        async function runAnalysisInternal(forceReload = true, showLoading = true) {
            const database = currentDatabase;
            const layout = document.getElementById('layoutSelect').value;
            const showLabels = document.getElementById('showLabels').checked;

            if (!database) return null;

            // Show loading state
            if (showLoading) {
                const vizArea = document.getElementById('visualization-area');
                vizArea.innerHTML = `
                    <div class="spinner-border text-primary" role="status"></div>
                    <h5 class="text-muted mt-3">Analyzing ${database}...</h5>
                    <p class="text-muted">This may take a few moments</p>
                `;
            }

            // Prepare analysis request
            const analysisData = {
                database_name: database,
                layout: layout,
                show_labels: showLabels,
                filters: currentFilters,
                force_reload: forceReload
            };

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisData)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    if (showLoading) {
                        displayVisualization(data);
                        updateStats(data);
                        showAnalysisResults(data.statistics);
                    }
                    return data;
                } else {
                    if (showLoading) {
                        showError('Analysis failed: ' + data.message);
                    }
                    return null;
                }
            } catch (error) {
                console.error('Error running analysis:', error);
                if (showLoading) {
                    showError('Connection error during analysis');
                }
                return null;
            }
        }

        function loadAvailableDatabases() {
            console.log('🔄 Loading available databases...');
            
            const select = document.getElementById('databaseSelect');
            if (!select) {
                console.error('❌ Database select element not found');
                return;
            }
            
            // Show loading state
            select.innerHTML = '<option value="">Loading databases...</option>';
            select.disabled = true;
            
            fetch('/api/databases')
                .then(response => {
                    console.log(`📡 API response status: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('📊 Raw API response:', data);
                    
                    // Reset select element
                    select.innerHTML = '<option value="">Select database...</option>';
                    select.disabled = false;
                    
                    // Handle various response formats
                    let databases = [];
                    let loadedDatabases = [];
                    let success = false;
                    
                    // Primary format: {status: 'success', available: [...], loaded: [...]}
                    if (data && data.status === 'success') {
                        databases = data.available || [];
                        loadedDatabases = data.loaded || [];
                        success = true;
                        console.log(`✅ Standard format: ${databases.length} available, ${loadedDatabases.length} loaded`);
                    }
                    // Fallback format 1: {databases: [...], loaded: [...]}
                    else if (data && data.databases) {
                        databases = data.databases;
                        loadedDatabases = data.loaded || [];
                        success = true;
                        console.log(`✅ Fallback format 1: ${databases.length} databases found`);
                    }
                    // Fallback format 2: {available: [...]}
                    else if (data && data.available) {
                        databases = data.available;
                        loadedDatabases = [];
                        success = true;
                        console.log(`✅ Fallback format 2: ${databases.length} databases found`);
                    }
                    // Fallback format 3: Direct array
                    else if (Array.isArray(data)) {
                        databases = data;
                        loadedDatabases = [];
                        success = true;
                        console.log(`✅ Fallback format 3: ${databases.length} databases in array`);
                    }
                    
                    if (success && databases.length > 0) {
                        // Populate dropdown with databases
                        databases.forEach(db => {
                            if (db && typeof db === 'string') {
                                const option = document.createElement('option');
                                option.value = db;
                                option.textContent = db.replace(/_/g, ' ').toUpperCase();
                                
                                // Check if database is loaded
                                if (loadedDatabases.includes(db)) {
                                    option.textContent += ' (Loaded)';
                                    option.style.fontWeight = 'bold';
                                    option.style.color = '#28a745';
                                }
                                
                                select.appendChild(option);
                            }
                        });
                        
                        console.log(`✅ Successfully populated dropdown with ${databases.length} databases`);
                        
                        // Show success notification if available
                        if (typeof showNotification === 'function') {
                            showNotification(`Loaded ${databases.length} available databases`, 'success');
                        }
                    } else if (success && databases.length === 0) {
                        // No databases available
                        console.warn('⚠️ No databases available');
                        select.innerHTML = '<option value="">No databases available</option>';
                        
                        if (typeof showNotification === 'function') {
                            showNotification('No databases are currently available', 'warning');
                        }
                    } else {
                        // API returned error status or unexpected format
                        const errorMsg = data.message || data.error || 'Unknown API error';
                        console.error('❌ API error:', errorMsg);
                        console.error('❌ Full response data:', data);
                        
                        select.innerHTML = '<option value="">Error loading databases</option>';
                        
                        if (typeof showNotification === 'function') {
                            showNotification(`Database loading failed: ${errorMsg}`, 'error');
                        }
                        
                        // Attempt fallback with hardcoded database list
                        loadFallbackDatabases();
                    }
                })
                .catch(error => {
                    console.error('❌ Network/fetch error:', error.message);
                    console.error('❌ Full error object:', error);
                    
                    // Reset select element
                    select.innerHTML = '<option value="">Connection error</option>';
                    select.disabled = false;
                    
                    // Show user-friendly error message
                    if (typeof showNotification === 'function') {
                        showNotification(`Failed to load databases: ${error.message}`, 'error');
                    }
                    
                    // Attempt fallback with hardcoded database list
                    loadFallbackDatabases();
                });
        }
        
        function loadFallbackDatabases() {
            console.log('🔄 Attempting fallback database loading...');
            
            const select = document.getElementById('databaseSelect');
            if (!select) return;
            
            // Common database names as fallback
            const fallbackDatabases = [
                'ies4_military_complete',
                'ies4_ukraine_military',
                'ies4_russia_military',
                'ies4_nato_military',
                'default_military'
            ];
            
            try {
                // Clear existing options except the first one
                select.innerHTML = '<option value="">Select database...</option>';
                
                fallbackDatabases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db;
                    option.textContent = db.replace(/_/g, ' ').toUpperCase() + ' (Fallback)';
                    option.style.fontStyle = 'italic';
                    option.style.color = '#6c757d';
                    select.appendChild(option);
                });
                
                console.log(`✅ Loaded ${fallbackDatabases.length} fallback databases`);
                
                if (typeof showNotification === 'function') {
                    showNotification('Using fallback database list - some features may be limited', 'warning');
                }
            } catch (fallbackError) {
                console.error('❌ Fallback loading also failed:', fallbackError);
            }
        }

        function loadFilterSuggestions() {
            console.log('🔍 Loading filter suggestions...');
            fetch('/api/filter_suggestions')
                .then(response => {
                    console.log('Filter suggestions response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Filter suggestions data:', data);
                    if (data.status === 'success') {
                        const suggestions = data.suggestions;
                        
                        // Populate country filter
                        const countrySelect = document.getElementById('countryFilterSelect');
                        if (countrySelect && suggestions.countries) {
                            suggestions.countries.forEach(country => {
                                const option = document.createElement('option');
                                option.value = country;
                                option.textContent = country.toUpperCase();
                                countrySelect.appendChild(option);
                            });
                            console.log(`✅ Loaded ${suggestions.countries.length} countries`);
                        } else {
                            console.warn('❌ Country filter element or data not found');
                        }

                        // Populate type filter
                        const typeSelect = document.getElementById('typeFilterSelect');
                        if (typeSelect && suggestions.types) {
                            suggestions.types.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                typeSelect.appendChild(option);
                            });
                            console.log(`✅ Loaded ${suggestions.types.length} entity types`);
                        } else {
                            console.warn('❌ Type filter element or data not found');
                        }
                        
                        // Log all available suggestions
                        console.log('All filter suggestions loaded:', Object.keys(suggestions));
                    } else {
                        console.error('❌ Filter suggestions API error:', data.message);
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading filter suggestions:', error);
                    // Add fallback options
                    this.addFallbackFilterOptions();
                });
        }

        function loadEquipmentCategories() {
            console.log('🏭 Loading equipment categories...');
            fetch('/api/equipment_categories')
                .then(response => {
                    console.log('Equipment categories response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Equipment categories data:', data);
                    if (data.status === 'success') {
                        const container = document.getElementById('equipment-category-checkboxes');
                        if (container) {
                            container.innerHTML = '';
                            
                            const categories = data.categories;
                            Object.entries(categories).forEach(([key, category]) => {
                                const checkboxDiv = document.createElement('div');
                                checkboxDiv.className = 'form-check equipment-category-checkbox';
                                
                                checkboxDiv.innerHTML = `
                                    <input class="form-check-input" type="checkbox" id="category_${key}" value="${key}">
                                    <label class="form-check-label" for="category_${key}">
                                        ${category.label}
                                        <small>${category.description}</small>
                                    </label>
                                `;
                                
                                container.appendChild(checkboxDiv);
                            });
                            console.log(`✅ Loaded ${Object.keys(categories).length} equipment categories`);
                        } else {
                            console.error('❌ Equipment category container not found');
                        }
                    } else {
                        console.error('❌ Equipment categories API error:', data.message);
                        this.addFallbackEquipmentCategories();
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading equipment categories:', error);
                    this.addFallbackEquipmentCategories();
                });
        }

        // Add fallback filter options if API fails
        window.addFallbackFilterOptions = function() {
            console.log('📋 Adding fallback filter options...');
            
            // Fallback countries
            const countrySelect = document.getElementById('countryFilterSelect');
            if (countrySelect) {
                const fallbackCountries = ['uk', 'usa', 'russia', 'china', 'poland', 'germany', 'sweden', 'finland', 'iran', 'france'];
                fallbackCountries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country.toUpperCase();
                    countrySelect.appendChild(option);
                });
                console.log('✅ Added fallback countries');
            }

            // Fallback types
            const typeSelect = document.getElementById('typeFilterSelect');
            if (typeSelect) {
                const fallbackTypes = ['country', 'vehicle', 'organization', 'area', 'weapon', 'person', 'militaryOrganization'];
                fallbackTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    typeSelect.appendChild(option);
                });
                console.log('✅ Added fallback entity types');
            }
        };

        // Add fallback equipment categories if API fails
        window.addFallbackEquipmentCategories = function() {
            console.log('🏭 Adding fallback equipment categories...');
            
            const container = document.getElementById('equipment-category-checkboxes');
            if (container) {
                const fallbackCategories = {
                    'vehicles': { label: 'Vehicles', description: 'All types of vehicles' },
                    'aircraft_unmanned': { label: 'Aircraft & Unmanned', description: 'Aircraft, drones, UAVs' },
                    'naval_assets': { label: 'Naval Assets', description: 'Ships, vessels, boats' },
                    'weapons_defense': { label: 'Weapons & Defense', description: 'Weapons and defense systems' },
                    'communication_electronics': { label: 'Communications', description: 'Communication equipment' }
                };

                Object.entries(fallbackCategories).forEach(([key, category]) => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'form-check equipment-category-checkbox';
                    
                    checkboxDiv.innerHTML = `
                        <input class="form-check-input" type="checkbox" id="category_${key}" value="${key}">
                        <label class="form-check-label" for="category_${key}">
                            ${category.label}
                            <small>${category.description}</small>
                        </label>
                    `;
                    
                    container.appendChild(checkboxDiv);
                });
                console.log('✅ Added fallback equipment categories');
            }
        };

        function displayVisualization(data) {
            const vizArea = document.getElementById('visualization-area');
            vizArea.innerHTML = '';
            vizArea.style.border = 'none';

            // Create the plot
            currentVisualization = data.visualization;
            Plotly.newPlot('visualization-area', data.visualization.data, data.visualization.layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            });
        }

        function updateStats(data) {
            document.getElementById('stat-nodes').textContent = data.node_count.toLocaleString();
            document.getElementById('stat-edges').textContent = data.edge_count.toLocaleString();
            
            const density = data.edge_count > 0 ? (data.edge_count / (data.node_count * (data.node_count - 1) / 2)).toFixed(3) : '0';
            document.getElementById('stat-density').textContent = density;
        }

        function showAnalysisResults(statistics) {
            const resultsDiv = document.getElementById('analysis-results');
            resultsDiv.style.display = 'block';

            // Top entities by centrality
            const topEntitiesDiv = document.getElementById('top-entities');
            if (statistics.centrality && statistics.centrality.top_degree_centrality) {
                let html = '<ul class="list-unstyled">';
                statistics.centrality.top_degree_centrality.slice(0, 5).forEach(([entity, score]) => {
                    html += `<li><strong>${entity}</strong> (${score.toFixed(3)})</li>`;
                });
                html += '</ul>';
                topEntitiesDiv.innerHTML = html;
            }

            // Entity distribution
            const distributionDiv = document.getElementById('entity-distribution');
            if (statistics.node_statistics && statistics.node_statistics.node_types) {
                let html = '<ul class="list-unstyled">';
                Object.entries(statistics.node_statistics.node_types).forEach(([type, count]) => {
                    html += `<li><strong>${type.replace(/_/g, ' ')}</strong>: ${count}</li>`;
                });
                html += '</ul>';
                distributionDiv.innerHTML = html;
            }
        }

        function applyFilters() {
            currentFilters = {};

            // Collect filter values
            const country = document.getElementById('countryFilterSelect').value;
            const type = document.getElementById('typeFilterSelect').value;
            const yearFrom = document.getElementById('yearFrom').value;
            const yearTo = document.getElementById('yearTo').value;
            const keyword = document.getElementById('keywordInput').value.trim();

            // Collect selected equipment categories
            const selectedCategories = [];
            document.querySelectorAll('input[id^="category_"]:checked').forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });

            if (country) currentFilters.country = country;
            if (type) currentFilters.type = type;
            if (yearFrom && yearTo) currentFilters.year_range = `${yearFrom}-${yearTo}`;
            else if (yearFrom) currentFilters.year = parseInt(yearFrom);
            if (keyword) currentFilters.keyword = keyword;
            if (selectedCategories.length > 0) currentFilters.equipment_category = selectedCategories;

            updateActiveFilters();

            // Re-run analysis if database is selected
            if (currentDatabase) {
                // Pause auto-refresh temporarily for manual filter application
                const wasAutoRefreshEnabled = autoRefreshEnabled;
                if (autoRefreshEnabled) {
                    stopAutoRefresh();
                }
                
                runAnalysisInternal(true, true).then(() => {
                    if (wasAutoRefreshEnabled) {
                        autoRefreshEnabled = true;
                        document.getElementById('autoRefreshToggle').checked = true;
                        startAutoRefresh();
                    }
                    logChange('Filters applied');
                });
            }
        }

        function clearFilters() {
            currentFilters = {};
            
            // Clear form fields
            document.getElementById('countryFilterSelect').value = '';
            document.getElementById('typeFilterSelect').value = '';
            document.getElementById('yearFrom').value = '';
            document.getElementById('yearTo').value = '';
            document.getElementById('keywordInput').value = '';

            // Clear equipment category checkboxes
            document.querySelectorAll('input[id^="category_"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            updateActiveFilters();

            // Re-run analysis if database is selected
            if (currentDatabase) {
                // Pause auto-refresh temporarily for manual filter clearing
                const wasAutoRefreshEnabled = autoRefreshEnabled;
                if (autoRefreshEnabled) {
                    stopAutoRefresh();
                }
                
                runAnalysisInternal(true, true).then(() => {
                    if (wasAutoRefreshEnabled) {
                        autoRefreshEnabled = true;
                        document.getElementById('autoRefreshToggle').checked = true;
                        startAutoRefresh();
                    }
                    logChange('Filters cleared');
                });
            }
        }

        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('active-filters');
            
            if (Object.keys(currentFilters).length === 0) {
                activeFiltersDiv.innerHTML = '<small class="text-muted">No active filters</small>';
            } else {
                let html = '';
                Object.entries(currentFilters).forEach(([key, value]) => {
                    if (key === 'equipment_category' && Array.isArray(value)) {
                        // Special handling for equipment categories
                        html += `<span class="filter-badge">${key}: ${value.length} selected</span>`;
                    } else {
                        html += `<span class="filter-badge">${key}: ${value}</span>`;
                    }
                });
                activeFiltersDiv.innerHTML = html;
            }
        }

        function exportVisualization() {
            if (currentVisualization) {
                Plotly.downloadImage('visualization-area', {
                    format: 'png',
                    filename: `military_analysis_${currentDatabase}_${Date.now()}`,
                    height: 800,
                    width: 1200
                });
            } else {
                alert('No visualization to export. Please run an analysis first.');
            }
        }

        function fullscreenView() {
            if (currentVisualization) {
                const elem = document.getElementById('visualization-area');
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }
        }

        function showError(message) {
            const vizArea = document.getElementById('visualization-area');
            vizArea.innerHTML = `
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5 class="text-danger">Error</h5>
                <p class="text-muted">${message}</p>
            `;
            vizArea.style.border = '2px dashed #ddd';
        }

        // Clean up timers when page is unloaded
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Pause auto-refresh when tab is not visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (autoRefreshEnabled && refreshTimer) {
                    stopAutoRefresh();
                    logChange('Auto-refresh paused (tab hidden)');
                }
            } else {
                if (autoRefreshEnabled && currentDatabase && !refreshTimer) {
                    startAutoRefresh();
                    logChange('Auto-refresh resumed (tab visible)');
                }
            }
        });
		
		// This should be at the bottom of analysis.html
		document.addEventListener('DOMContentLoaded', function() {
			loadAvailableDatabases();
			loadFilterSuggestions();
			loadEquipmentCategories();
		});
    </script>
    
    <!-- Data Popup System -->
    <script src="/static/js/data-popup.js"></script>
</body>
</html>
                    